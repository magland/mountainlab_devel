samplefreq=30000
freq_min=300
freq_max=10000
detect_threshold=3.5
clip_size=200
branch_thresholds=3.5,4,5,6
isocut_threshold=1.5
K_init=30
num_features=6

echo "*** COPY ***"
mscmd copy
	--input=$1
	--output=pre0.mda

echo "*** BANDPASS FILTER ***"
mscmd bandpass_filter
	--input=pre0.mda
	--output=pre1.mda
	--samplefreq=$samplefreq
	--freq_min=$freq_min
	--freq_max=$freq_max

echo "*** WHITEN ***"
mscmd whiten
	--input=pre1.mda
	--output=pre2.mda

echo "*** DETECT ***"
mscmd detect
	--input=pre2.mda
	--output=detect0.mda
	--threshold=$detect_threshold
	--individual_channels=0 --normalize=0
	--inner_window_width=15 --outer_window_width=1000

echo "*** EXTRACT CLIPS ***"
mscmd extract_clips
	--input=pre2.mda
	--detect=detect0.mda
	--output_clips=clips0.mda
	--clip_size=$clip_size

echo "*** ISOBRANCH ***"
mscmd isobranch
	--input_clips=clips0.mda
	--output_labels=labels0.mda
	--branch_thresholds=$branch_thresholds
	--isocut_threshold=$isocut_threshold
	--K_init=$K_init
	--num_features=$num_features

echo "*** ASSEMBLE CLUSTERS FILE ***"
mscmd assemble_clusters_file
	--input_detect=detect0.mda
	--input_labels=labels0.mda
	--output_clusters=clusters.mda

echo "*** TEMPLATES ***"
mscmd templates
	--input=pre2.mda
	--clusters=clusters.mda
	--output=templates.mda
	--clip_size=$clip_size

echo "*** TEMPLATES RAW ***"
mscmd templates
	--input=pre0.mda
	--clusters=clusters.mda
	--output=templates_raw.mda
	--clip_size=$clip_size

echo "*** TEMPLATES PRE1 ***"
mscmd templates
	--input=pre1.mda
	--clusters=clusters.mda
	--output=templates_pre1.mda
	--clip_size=$clip_size

echo "*** CROSS CORRELOGRAMS ***"
mscmd cross_correlograms
	--clusters=clusters.mda
	--output=cross_correlograms.mda
	--max_dt=10000

echo "*** CREATE CLIPS FILE ***"
mscmd create_clips_file
	--input=pre2.mda
	--clusters=clusters.mda
	--output=clips.mda
	--index_out=clips_index.mda
	--clip_size=$clip_size

echo "*** CREATE CLIPS FILE PRE1 ***"
mscmd create_clips_file
	--input=pre1.mda
	--clusters=clusters.mda
	--output=clips_pre1.mda
	--index_out=clips_pre1_index.mda
	--clip_size=$clip_size


$mountainview \
	--raw=pre2.mda --templates=templates.mda --clips=clips.mda --clusters=clusters.mda --clips-index=clips_index.mda --cross-correlograms=cross_correlograms.mda 

